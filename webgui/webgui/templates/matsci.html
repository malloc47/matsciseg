<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Materials Segmentation Interactive Segmentation Demo</title>
    <script src="/js/jquery-1.7.2.js" type="text/javascript"></script>
    <style type="text/css">
    .container {
	max-width:960px;
	margin:0px auto;
	border:1px solid;
	border-bottom:0px solid;
    }
    .navbar {
	width:160px;
	float:left;
	margin:10px;
    }
    .workingarea {
	padding:10px;
	width:750px;
	height:530px;
	overflow:auto;
    }
    .rawoutput {
	overflow:auto;
	height:350px;
	font-size:10pt;
    }
    .bottombar {
	max-width:960px;
	margin:0px auto;
	border:1px solid;
	overflow:auto;
	overflow-y: hidden;
	overflow-x: scroll;

    }
    .bottombar ul {
	padding:10px;
	margin:0px;
    }
    .bottombar li {
	float:left;
	list-style-type: none;
	padding-left:0px;
    }
    .bottombar img {
	padding-left:5px;
	padding-right:5px;
    }
    .bottombar p {
	margin:0px;
	text-align:center;
    }
    .selected {
	border:1px solid;
    }
    </style>
    <script type="text/javascript">

    var mode = 'none';
    var state = {};
    var addition = [];
    var removal  = [];

    function log_output(str) {
	$('.rawoutput').append('<p>'+
			       '['+new Date().toTimeString()+'] '+
			       str+'</p>');
	$(".rawoutput").prop({ scrollTop: $(".rawoutput").prop("scrollHeight") }, 30);	
    }

    function change_mode(new_mode) {
	mode = mode==new_mode ? 'none' : new_mode;
	modes = {'none':{'cursor':'default'},'addition':{'cursor':'crosshair'},'removal':{'cursor':'move'}};
	$('.mainimg').css(modes[mode]);
	log_output('mode changed to '+mode);
    }

    function tuples_to_str(l) {
	output = '';
	for (var i=0; i<l.length; i++) {
	    output += l[i][0].toString()+','+l[i][1].toString()+';';
	}
	// don't grab last ";"
	if(output[output.length-1] == ';') {
	    return output.substr(0,output.length-1);
	}
	else {
	    return output;
	}
    }

    function pad(number, length) {    
	var str = '' + number;
	while (str.length < length) {
	    str = '0' + str;
	}
	return str;
    }

    function getstate() {
	$.getJSON("/state/",function(data) {
	    state = data;
    	    parsestate();
	});
    }

    function sendstate() {
	$.getJSON("/state/",state);
    }

    function syncstate() {
    	$.getJSON("/state/",state,function(data) {
    	    state = data;
    	    parsestate();
    	});
    }

    function parsestate() {

	addition = [];
	removal  = [];

	// update bottom bar
	$('.bottombar ul').children().remove();
	for (var i = 0; i < state['images'].length; i++) {
	    $('.bottombar ul').append('<li'
				      + (state['images'][i]==state['image'] ? ' class="selected" ' : '')				      
				      + '><img class="thumb'
				      + state['images'][i]
				      // + (i==parseInt(state['image']) ? ' selected' : '')
				      + '" src="/thumb/'
				      + pad(state['images'][i],4)
				      + '/" '
				      + 'id="' + state['images'][i] + '" '
				      + '/><p>'
				      + state['images'][i]
				      + '</p></li>');
	}
	$('.bottombar ul li img').click(function(e) {
	    /* var c=$(this).attr('class').substr(5); */
	    var c=$(this).attr('id');
	    state['image'] = parseInt(c);
	    syncstate();
	});

	$('.mainimg').attr('src','/output/'+pad(state['image'],4)+'/');

	if('response' in state) {
	    log_output(state['response']);
	}
    }

      $(document).ready(function() {
	  $('#global,#local').click(function() {
	      var method = $(this).attr('id');
	      state['command'] = method;
	      state['addition'] = tuples_to_str(addition);
	      state['removal'] = tuples_to_str(removal);
	      syncstate();
	  });

	  $('#addition,#removal').click(function() {
	      change_mode($(this).attr('id'));
	  });

	  $('.mainimg').click(function(e) {
	      if(mode == 'none') return;
	      var x = e.pageX - this.offsetLeft;
              var y = e.pageY - this.offsetTop;
	      // state['command'] = 'imgclick';
	      // state['mode'] = mode;
	      // state['x'] = x;
	      // state['y'] = y;
	      window[mode].push([x,y]);
	      // syncstate();
	      // alert(window[mode]);
	      log_output(mode + ' at '+x+','+y);
	  });

	  getstate();

      });

// (function poll(){
//     $.ajax({ url: "server", success: function(data){
//         //Update your dashboard gauge
//         salesGauge.setValue(data.value);

//     }, dataType: "json", complete: poll, timeout: 30000 });
// })();

    </script>
  </head>
  <body>
    <div class="container">
      <div class="navbar">
	<h3>Tools</h3>
	<button type="button" id="addition">Addition</button>
	<button type="button" id="removal">Removal</button>
	<button type="button" id="global">Global</button>
	<button type="button" id="local">Local</button>
	<hr />
	<h3>Output</h3>
	<div class="rawoutput">
	</div>
      </div>
      <div class="workingarea">
	<img class="mainimg" src="/img/image0090.png" />
      </div>
    </div>
    <div class="bottombar">
      <ul style="width:1353px">
	<li><img class="thumb1" src="/img/thumb/image0090.png" /><p>90</p></li>
	<li><img class="thumb2" src="/img/thumb/image0091.png" /><p>91</p></li>
	<li><img class="thumb3" src="/img/thumb/image0092.png" /><p>92</p></li>
	<li><img class="thumb4" src="/img/thumb/image0093.png" /><p>93</p></li>
	<li><img class="thumb5" src="/img/thumb/image0094.png" /><p>94</p></li>
	<li><img class="thumb6" src="/img/thumb/image0095.png" /><p>95</p></li>
	<li><img class="thumb7" src="/img/thumb/image0096.png" /><p>96</p></li>
	<li><img class="thumb8" src="/img/thumb/image0097.png" /><p>97</p></li>
	<li><img class="thumb9" src="/img/thumb/image0098.png" /><p>98</p></li>
	<li><img class="thumb10" src="/img/thumb/image0099.png" /><p>99</p></li>
	<li><img class="thumb11" src="/img/thumb/image0100.png" /><p>100</p></li>
      </ul>
    </div>
  </body>
</html>
