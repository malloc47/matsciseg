<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Materials Segmentation Interactive Segmentation Demo</title>
    <script src="/js/jquery-1.7.2.js" type="text/javascript"></script>
    <style type="text/css">
    .container {
	max-width:1000px;
	margin:0px auto;
	border:1px solid;
	border-bottom:0px solid;
    }
    .container2 {
	height:1%;
	overflow:hidden;
    }
    .navbar {
	width:70px;
	float:left;
	margin:10px;
    }
    .workingarea {
	padding:10px;
	width:710px;
	height:600px;
	overflow:auto;
	float:left;
    }
    .rawoutput {
	overflow:auto;
	height:620px;
	font-size:10pt;
	float:right;
	width:170px;
    }
    .bottombar {
	max-width:1000px;
	margin:0px auto;
	border:1px solid;
	overflow:auto;
	overflow-y: hidden;
	overflow-x: scroll;
    }
    .bottombar ul {
	padding:10px;
	margin:0px;
    }
    .bottombar li {
	float:left;
	list-style-type: none;
	padding-left:0px;
    }
    .bottombar img {
	padding-left:5px;
	padding-right:5px;
    }
    .bottombar p {
	margin:0px;
	text-align:center;
    }
    .selected {
	border:1px solid;
    }
    h3 {
	text-align:center;
    }
    button {
	display:block;
	width:70px;
	background:#CCCCCC;
    }
    .output{
	color:#777777;
	padding:0px;
	margin:0px;
    }
    .errormsg{
	color:#770000;
    }
    .output li {
	list-style-type: none;
	padding-left:0px;
    }
    </style>
    <script type="text/javascript">

    var mode = 'none';
    var state = {};
    var addition = [];
    var removal  = [];
    var ctx;

    var img_paths = {'img' : 'empty',
		     'seg' : 'output',
		     'edg' : 'edge'};

    var img_mode = 'seg';

    var mainimg = new Image();
    mainimg.onload = function(){
	ctx.globalAlpha = 1.0;
	ctx.drawImage(mainimg,0,0,state['width'],state['height'],0,0,state['width']*2,state['height']*2);
	ctx.redraw();
	// ctx.drawImage(mainimg,0,0);
    };
    mainimg.src = "/img/image0090.png";

    function log_output(str) {
	if(str.indexOf('error:') === 0) {
	    $('.output').append('<li class="errormsg">'+
				// '['+new Date().toTimeString()+'] '+
				str+'</li>');
	}
	else {
	    $('.output').append('<li>'+
				// '['+new Date().toTimeString()+'] '+
				str+'</li>');
	}
	$(".rawoutput").prop({ scrollTop: $(".rawoutput").prop("scrollHeight") }, 30);	
    }

    function change_mode(new_mode) {
	mode = mode==new_mode ? 'none' : new_mode;
	modes = {'none':{'cursor':'default'},'addition':{'cursor':'crosshair'},'removal':{'cursor':'move'}};
	$('#mainimg').css(modes[mode]);
	log_output('mode changed to '+mode);
    }

    function tuples_to_str(l) {
	output = '';
	for (var i=0; i<l.length; i++) {
	    output += l[i][0].toString()+','+l[i][1].toString()+';';
	}
	// don't grab last ";"
	if(output[output.length-1] == ';') {
	    return output.substr(0,output.length-1);
	}
	else {
	    return output;
	}
    }

    function pad(number, length) {    
	var str = '' + number;
	while (str.length < length) {
	    str = '0' + str;
	}
	return str;
    }

    function getstate() {
	$.getJSON("/state/",function(data) {
	    state = data;
    	    parsestate();
	});
    }

    function sendstate() {
	$.getJSON("/state/",state);
    }

    function syncstate() {
    	$.getJSON("/state/",state,function(data) {
    	    state = data;
    	    parsestate();
    	});
    }

    function parsestate() {
	addition = [];
	removal  = [];
	// update bottom bar
	$('.bottombar ul').children().remove();
	$('.bottombar ul').css({'width':(124*state['images'].length+20).toString()});
	for (var i = 0; i < state['images'].length; i++) {
	    $('.bottombar ul').append('<li'
				      + (state['images'][i]==state['image'] ? ' class="selected" ' : '')				      
				      + '><img class="thumb'
				      + state['images'][i]
				      // + (i==parseInt(state['image']) ? ' selected' : '')
				      + '" src="/thumb/'
				      + pad(state['images'][i],4)
				      + '/" '
				      + 'id="' + state['images'][i] + '" '
				      + '/><p>'
				      + state['images'][i]
				      + '</p></li>');
	}
	$('.bottombar ul li img').click(function(e) {
	    ctx.lighten();
	    var c=$(this).attr('id');
	    state['image'] = parseInt(c);
	    log_output("opening slice "+c);
	    syncstate();
	});

	if($('#mainimg').attr('width') != state['width']*2)
	    $('#mainimg').attr('width',state['width']*2);
	if($('#mainimg').attr('height') != state['height']*2)
	    $('#mainimg').attr('height',state['height']*2);

	mainimg.src = '/' + img_paths[img_mode] + '/'+pad(state['image'],4)+'/?'+new Date().getTime();

	if('response' in state) {
	    log_output(state['response']);
	}
    }

      $(document).ready(function() {
	  $('.serversend').click(function() {
	      var method = $(this).attr('id');
	      log_output("starting "+method);
	      ctx.lighten();
	      state['command'] = method;
	      state['addition'] = tuples_to_str(addition);
	      state['removal'] = tuples_to_str(removal);
	      syncstate();
	  });

	  $('.dataset').click(function() {
	      var dataset = $(this).attr('id');
	      log_output("changing to "+dataset);
	      ctx.lighten();
	      state['command'] = 'dataset';
	      state['dataset'] = dataset;
	      syncstate();
	  });

	  $('.imgtype').click(function() {
	      var m = $(this).attr('id');
	      log_output(m+" view");
	      ctx.lighten();
	      img_mode = m;
	      $('.imgtype').css({"background":"#CCCCCC"});
	      $(this).css({"background":"#AAAACC"});
	      mainimg.src = '/' + img_paths[img_mode] + '/'+pad(state['image'],4)+'/?'+new Date().getTime();
	  });

	  $('.interaction').click(function() {
	      change_mode($(this).attr('id'));
	      $('.interaction').css({"background":"#CCCCCC"});
	      if(mode != 'none')
		  $(this).css({"background":"#CCAAAA"});
	  });

	  $('#reset').click(function() {
	      addition = [];
	      removal  = [];
	      mainimg.onload();
	      $('.output').children().remove();
	      log_output("reset successful")
	  });

	  ctx = $("#mainimg")[0].getContext('2d');

	  ctx.fillCircle = function(x, y, radius, fillColor) {
              this.fillStyle = fillColor;
              this.beginPath();
              this.moveTo(x, y);
              this.arc(x, y, radius, 0, Math.PI * 2, false);
              this.fill();
	  };

	  ctx.fillX = function(x, y, radius, fillColor) {
	      this.fillCircle(x,y,radius,'#000000');
              this.strokeStyle = fillColor;
              this.beginPath();
              this.moveTo(x, y);
	      this.lineTo(x+radius,y+radius);
              this.moveTo(x, y);
	      this.lineTo(x-radius,y-radius);
              this.moveTo(x, y);
	      this.lineTo(x+radius,y-radius);
              this.moveTo(x, y);
	      this.lineTo(x-radius,y+radius);
              this.stroke();
	  };

	  ctx.lighten = function() {
	      this.fillStyle = '#FFFFFF';
	      this.fillRect(0,0,$('#mainimg').attr('width'),$('#mainimg').attr('height'));
	      this.globalAlpha = 0.25;
	      // this.drawImage(mainimg,0,0);
	      ctx.drawImage(mainimg,0,0,state['width'],state['height'],0,0,state['width']*2,state['height']*2);
	  }

	  ctx.redraw = function() {
	      for (var i=0; i<addition.length; i++) {
		  ctx.fillCircle(addition[i][0]*2, addition[i][1]*2, 5, '#ffffff');
	      }
	      for (var i=0; i<removal.length; i++) {
		  ctx.fillX(removal[i][0]*2, removal[i][1]*2, 5, '#ffffff');
	      }
	  }

	  $('#mainimg').click(function(e) {
	      if(mode == 'none') return;
	      var x = e.pageX - this.offsetLeft + $('.workingarea').scrollLeft();
              var y = e.pageY - this.offsetTop + $('.workingarea').scrollTop();
	      x_new = Math.floor(x/2);
	      y_new = Math.floor(y/2);
	      window[mode].push([x_new,y_new]);
	      if(mode == 'addition')
		  ctx.fillCircle(x, y, 5, '#ffffff');
	      else if(mode == 'removal')
		  ctx.fillX(x, y, 5, '#ffffff');
	      log_output(mode + ' at '+x_new+','+y_new);
	  });

	  getstate();

      });

// (function poll(){
//     $.ajax({ url: "server", success: function(data){
//         //Update your dashboard gauge
//         salesGauge.setValue(data.value);

//     }, dataType: "json", complete: poll, timeout: 30000 });
// })();

    </script>
</head>
<body>
  <div class="container">
    <div class="container2">
      <div class="navbar">
	<h3>Tools</h3>
	<button type="button" id="addition" class="interaction">Addition</button>
	<button type="button" id="removal" class="interaction">Removal</button>
        <hr />
	<button type="button" id="img" class="imgtype">Image</button>
	<button type="button" id="seg" class="imgtype">Segment.</button>
	<button type="button" id="edg" class="imgtype">Edges</button>
        <hr />
	<button type="button" id="global" class="serversend">Global</button>
	<button type="button" id="local" class="serversend">Local</button>
        <hr />
        <button type="button" id="copyr" class="serversend">&gt;&gt;Copy</button>
        <button type="button" id="copyl" class="serversend">&lt;&lt;Copy</button>
        <hr />
	<button type="button" id="reset">Reset</button>
	<h3>Datasets</h3>
	<button type="button" id="ti" class="dataset">&beta;-Ti Grains</button>
	<!-- <button type="button" id="s1" class="dataset">Cropped</button> -->

      </div>
      <div class="workingarea">
	<!-- <img class="mainimg" src="/img/image0090.png" /> -->
	<canvas id="mainimg" width="750" height="525"></canvas>
      </div>
      <div class="rawoutput"><h3>Output</h3><ul class="output"></ul></div>
    </div>
  </div>
  <div class="bottombar">
    <ul style="width:1353px">
      <li><img class="thumb1" src="/img/thumb/image0090.png" /><p>90</p></li>
      <li><img class="thumb2" src="/img/thumb/image0091.png" /><p>91</p></li>
      <li><img class="thumb3" src="/img/thumb/image0092.png" /><p>92</p></li>
      <li><img class="thumb4" src="/img/thumb/image0093.png" /><p>93</p></li>
      <li><img class="thumb5" src="/img/thumb/image0094.png" /><p>94</p></li>
      <li><img class="thumb6" src="/img/thumb/image0095.png" /><p>95</p></li>
      <li><img class="thumb7" src="/img/thumb/image0096.png" /><p>96</p></li>
      <li><img class="thumb8" src="/img/thumb/image0097.png" /><p>97</p></li>
      <li><img class="thumb9" src="/img/thumb/image0098.png" /><p>98</p></li>
      <li><img class="thumb10" src="/img/thumb/image0099.png" /><p>99</p></li>
      <li><img class="thumb11" src="/img/thumb/image0100.png" /><p>100</p></li>
    </ul>
  </div>
</body>
</html>
